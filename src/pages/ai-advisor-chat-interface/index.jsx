import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import Header from '../../components/ui/Header';
import ChatHeader from './components/ChatHeader';
import ConversationHistory from './components/ConversationHistory';
import ChatInput from './components/ChatInput';
import QuickActionButtons from './components/QuickActionButtons';
import AIInsightPanel from './components/AIInsightPanel';
import Icon from '../../components/AppIcon';

const AIAdvisorChatInterface = () => {
  const navigate = useNavigate();
  const [currentLanguage, setCurrentLanguage] = useState('en');
  const [messages, setMessages] = useState([]);
  const [isTyping, setIsTyping] = useState(false);
  const [isOnline, setIsOnline] = useState(true);
  const [isListening, setIsListening] = useState(false);
  const [showInsightPanel, setShowInsightPanel] = useState(true);

  // Mock conversation data
  const sampleConversations = {
    hi: [
      {
        id: 1,
        sender: 'ai',
        content: `рдирдорд╕реНрддреЗ! рдореИрдВ рдЖрдкрдХрд╛ рд╡реНрдпрдХреНрддрд┐рдЧрдд рд╡рд┐рддреНрддреАрдп рд╕рд▓рд╛рд╣рдХрд╛рд░ рд╣реВрдБред рдореИрдВ рдЖрдкрдХреА рдирд┐рд╡реЗрд╢ рд░рдгрдиреАрддрд┐, рдЯреИрдХреНрд╕ рдкреНрд▓рд╛рдирд┐рдВрдЧ, рдФрд░ рд░рд┐рдЯрд╛рдпрд░рдореЗрдВрдЯ рдХреА рдпреЛрдЬрдирд╛ рдореЗрдВ рдорджрдж рдХрд░ рд╕рдХрддрд╛ рд╣реВрдБред\n\nрдЖрдЬ рдореИрдВ рдЖрдкрдХреА рдХреИрд╕реЗ рд╕рд╣рд╛рдпрддрд╛ рдХрд░ рд╕рдХрддрд╛ рд╣реВрдБ?`,
        timestamp: new Date(Date.now() - 300000),
        quickActions: [
          { id: 'portfolio', label: 'рдкреЛрд░реНрдЯрдлреЛрд▓рд┐рдпреЛ рджреЗрдЦреЗрдВ' },
          { id: 'goals', label: 'рд▓рдХреНрд╖реНрдп рд╕реЗрдЯ рдХрд░реЗрдВ' }
        ]
      },
      {
        id: 2,
        sender: 'user',
        content: 'рдореЗрд░реА retirement planning рдХреЗ рд▓рд┐рдП рдХреНрдпрд╛ strategy suggest рдХрд░реЗрдВрдЧреЗ?',
        timestamp: new Date(Date.now() - 240000)
      },
      {
        id: 3,
        sender: 'ai',
        content: `рдмрд╣реБрдд рдЕрдЪреНрдЫрд╛ рд╕рд╡рд╛рд▓! рдЖрдкрдХреА рд░рд┐рдЯрд╛рдпрд░рдореЗрдВрдЯ рдкреНрд▓рд╛рдирд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рдореИрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд░рдгрдиреАрддрд┐ рд╕реБрдЭрд╛рддрд╛ рд╣реВрдБ:\n\nЁЯОп **EPF рдЕрдиреБрдХреВрд▓рди**: рдЖрдкрдХрд╛ EPF рдпреЛрдЧрджрд╛рди рдЕрдзрд┐рдХрддрдо рдХрд░реЗрдВ\nЁЯТ░ **ELSS рдирд┐рд╡реЗрд╢**: рдЯреИрдХреНрд╕ рдмрдЪрдд рдХреЗ рд╕рд╛рде рдЗрдХреНрд╡рд┐рдЯреА рдПрдХреНрд╕рдкреЛрдЬрд╝рд░\nЁЯПа **PPF рдЦрд╛рддрд╛**: 15 рд╕рд╛рд▓ рдХрд╛ рд▓реЙрдХ-рдЗрди рдкреАрд░рд┐рдпрдб, рдЯреИрдХреНрд╕ рдлреНрд░реА рд░рд┐рдЯрд░реНрди\nЁЯУИ **SIP рд░рдгрдиреАрддрд┐**: рдорд╛рд╕рд┐рдХ тВ╣15,000 рдХрд╛ SIP рд╢реБрд░реВ рдХрд░реЗрдВ\n\nрдЖрдкрдХреА рд╡рд░реНрддрдорд╛рди рдЖрдпреБ рдФрд░ рдЖрдп рдХреЗ рдЖрдзрд╛рд░ рдкрд░, рдЖрдк 60 рд╕рд╛рд▓ рдХреА рдЙрдореНрд░ рддрдХ тВ╣2.5 рдХрд░реЛрдбрд╝ рдХрд╛ рдХреЙрд░реНрдкрд╕ рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВред`,
        timestamp: new Date(Date.now() - 180000),
        quickActions: [
          { id: 'sip_calculator', label: 'SIP рдХреИрд▓рдХреБрд▓реЗрдЯрд░' },
          { id: 'goal_tracker', label: 'рд▓рдХреНрд╖реНрдп рдЯреНрд░реИрдХрд░' }
        ]
      }
    ],
    en: [
      {
        id: 1,
        sender: 'ai',
        content: `Hello! I'm your personal financial advisor powered by AI. I can help you with investment strategies, tax planning, retirement planning, and much more.\n\nHow can I assist you today?`,
        timestamp: new Date(Date.now() - 300000),
        quickActions: [
          { id: 'portfolio', label: 'View Portfolio' },
          { id: 'goals', label: 'Set Goals' }
        ]
      },
      {
        id: 2,
        sender: 'user',
        content: 'What\'s the best retirement strategy for someone in their 30s?',
        timestamp: new Date(Date.now() - 240000)
      },
      {
        id: 3,
        sender: 'ai',
        content: `Excellent question! For someone in their 30s, here's a comprehensive retirement strategy:\n\nЁЯОп **Maximize EPF**: Ensure maximum employer contribution\nЁЯТ░ **ELSS Investments**: Tax-saving equity exposure\nЁЯПа **PPF Account**: 15-year lock-in with tax-free returns\nЁЯУИ **SIP Strategy**: Start with тВ╣15,000 monthly SIP\nЁЯПе **Health Insurance**: Adequate coverage for medical emergencies\n\nWith your current age and income profile, you can build a corpus of тВ╣2.5 crores by age 60 with disciplined investing.`,
        timestamp: new Date(Date.now() - 180000),
        quickActions: [
          { id: 'sip_calculator', label: 'SIP Calculator' },
          { id: 'goal_tracker', label: 'Goal Tracker' }
        ]
      }
    ]
  };

  // Initialize with sample conversation
  useEffect(() => {
    setMessages(sampleConversations?.[currentLanguage] || []);
  }, [currentLanguage]);

  const handleLanguageToggle = () => {
    const newLanguage = currentLanguage === 'hi' ? 'en' : 'hi';
    setCurrentLanguage(newLanguage);
    localStorage.setItem('preferredLanguage', newLanguage);
  };

  const handleSendMessage = (content) => {
    const userMessage = {
      id: Date.now(),
      sender: 'user',
      content,
      timestamp: new Date()
    };

    setMessages(prev => [...prev, userMessage]);
    setIsTyping(true);

    // Simulate AI response
    setTimeout(() => {
      const aiResponse = generateAIResponse(content);
      setMessages(prev => [...prev, aiResponse]);
      setIsTyping(false);
    }, 2000 + Math.random() * 2000);
  };

  const generateAIResponse = (userMessage) => {
    const responses = {
      hi: {
        portfolio: `рдЖрдкрдХрд╛ рдкреЛрд░реНрдЯрдлреЛрд▓рд┐рдпреЛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг:\n\nЁЯУК **рдХреБрд▓ рдирд┐рд╡реЗрд╢**: тВ╣8,50,000\nЁЯУИ **рд╡рд░реНрддрдорд╛рди рдореВрд▓реНрдп**: тВ╣9,75,000 (+14.7%)\nЁЯОп **рдПрд╕реЗрдЯ рдПрд▓реЛрдХреЗрд╢рди**: 70% рдЗрдХреНрд╡рд┐рдЯреА, 30% рдбреЗрдЯ\n\n**рд╕реБрдЭрд╛рд╡**: рдЖрдкрдХрд╛ рдкреЛрд░реНрдЯрдлреЛрд▓рд┐рдпреЛ рдЕрдЪреНрдЫрд╛ рдкреНрд░рджрд░реНрд╢рди рдХрд░ рд░рд╣рд╛ рд╣реИред рдорд┐рдб-рдХреИрдк рдПрдХреНрд╕рдкреЛрдЬрд╝рд░ рдмрдврд╝рд╛рдиреЗ рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░реЗрдВред`,
        tax: `рдЯреИрдХреНрд╕ рдмрдЪрдд рдХреЗ рдЕрд╡рд╕рд░:\n\nЁЯТ░ **80C**: тВ╣1,50,000 рдХреА рд╕реАрдорд╛ рдореЗрдВ рд╕реЗ тВ╣45,000 рдмрдЪрд╛ рд╣реИ\nЁЯПе **80D**: рд╣реЗрд▓реНрде рдЗрдВрд╢реНрдпреЛрд░реЗрдВрд╕ рдкреНрд░реАрдорд┐рдпрдо рдХреЗ рд▓рд┐рдП тВ╣25,000\nЁЯПа **рд╣реЛрдо рд▓реЛрди**: рдмреНрдпрд╛рдЬ рдкрд░ тВ╣2,00,000 рддрдХ рдХреА рдЫреВрдЯ\n\n**рдХреБрд▓ рдмрдЪрдд рд╕рдВрднрд╛рд╡рдирд╛**: тВ╣31,200`,
        goals: `рдЖрдЗрдП рдЖрдкрдХреЗ рд╡рд┐рддреНрддреАрдп рд▓рдХреНрд╖реНрдп рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░рддреЗ рд╣реИрдВ:\n\nЁЯПа **рдШрд░ рдЦрд░реАрджрдирд╛**: 5 рд╕рд╛рд▓ рдореЗрдВ тВ╣50 рд▓рд╛рдЦ\nЁЯОУ **рдмрдЪреНрдЪреЛрдВ рдХреА рд╢рд┐рдХреНрд╖рд╛**: 15 рд╕рд╛рд▓ рдореЗрдВ тВ╣25 рд▓рд╛рдЦ\nтЬИя╕П **рд░рд┐рдЯрд╛рдпрд░рдореЗрдВрдЯ**: 25 рд╕рд╛рд▓ рдореЗрдВ тВ╣2 рдХрд░реЛрдбрд╝\n\nрдХреНрдпрд╛ рдЖрдк рдЗрди рд▓рдХреНрд╖реНрдпреЛрдВ рдХреЗ рд▓рд┐рдП SIP рд╢реБрд░реВ рдХрд░рдирд╛ рдЪрд╛рд╣реЗрдВрдЧреЗ?`,
        market: `рдЖрдЬ рдХреЗ рдореБрдЦреНрдп рдмрд╛рдЬрд╛рд░ рдЕрдкрдбреЗрдЯ:\n\nЁЯУИ **рд╕реЗрдВрд╕реЗрдХреНрд╕**: +245 рдкреЙрдЗрдВрдЯреНрд╕ (0.42%)\nЁЯУК **рдирд┐рдлреНрдЯреА**: +78 рдкреЙрдЗрдВрдЯреНрд╕ (0.45%)\nЁЯТ╝ **рд╕реЗрдХреНрдЯрд░**: IT рдФрд░ рдлрд╛рд░реНрдорд╛ рдореЗрдВ рддреЗрдЬреА\nЁЯМН **рдЧреНрд▓реЛрдмрд▓**: US рдорд╛рд░реНрдХреЗрдЯ рдореЗрдВ рд╕рдХрд╛рд░рд╛рддреНрдордХ рд░реБрдЭрд╛рди\n\n**рд╕реБрдЭрд╛рд╡**: IT рд╕реНрдЯреЙрдХреНрд╕ рдореЗрдВ рдирд┐рд╡реЗрд╢ рдХрд╛ рдЕрдЪреНрдЫрд╛ рд╕рдордп рд╣реИред`
      },
      en: {
        portfolio: `Your Portfolio Analysis:\n\nЁЯУК **Total Investment**: тВ╣8,50,000\nЁЯУИ **Current Value**: тВ╣9,75,000 (+14.7%)\nЁЯОп **Asset Allocation**: 70% Equity, 30% Debt\n\n**Recommendation**: Your portfolio is performing well. Consider increasing mid-cap exposure for better growth potential.`,
        tax: `Tax Saving Opportunities:\n\nЁЯТ░ **80C**: тВ╣45,000 remaining out of тВ╣1,50,000 limit\nЁЯПе **80D**: тВ╣25,000 for health insurance premium\nЁЯПа **Home Loan**: Up to тВ╣2,00,000 interest deduction\n\n**Total Potential Savings**: тВ╣31,200`,
        goals: `Let's set your financial goals:\n\nЁЯПа **Home Purchase**: тВ╣50 lakhs in 5 years\nЁЯОУ **Children's Education**: тВ╣25 lakhs in 15 years\nтЬИя╕П **Retirement**: тВ╣2 crores in 25 years\n\nWould you like to start SIPs for these goals?`,
        market: `Today's Key Market Updates:\n\nЁЯУИ **Sensex**: +245 points (0.42%)\nЁЯУК **Nifty**: +78 points (0.45%)\nЁЯТ╝ **Sectors**: IT and Pharma leading gains\nЁЯМН **Global**: Positive sentiment from US markets\n\n**Suggestion**: Good time to invest in IT stocks.`
      }
    };

    const lang = currentLanguage;
    let responseContent = '';

    if (userMessage?.toLowerCase()?.includes('portfolio') || userMessage?.includes('рдкреЛрд░реНрдЯрдлреЛрд▓рд┐рдпреЛ')) {
      responseContent = responses?.[lang]?.portfolio;
    } else if (userMessage?.toLowerCase()?.includes('tax') || userMessage?.includes('рдЯреИрдХреНрд╕')) {
      responseContent = responses?.[lang]?.tax;
    } else if (userMessage?.toLowerCase()?.includes('goal') || userMessage?.includes('рд▓рдХреНрд╖реНрдп')) {
      responseContent = responses?.[lang]?.goals;
    } else if (userMessage?.toLowerCase()?.includes('market') || userMessage?.includes('рдорд╛рд░реНрдХреЗрдЯ')) {
      responseContent = responses?.[lang]?.market;
    } else {
      responseContent = lang === 'hi' 
        ? `рдореИрдВ рдЖрдкрдХреЗ рд╕рд╡рд╛рд▓ рдХреЛ рд╕рдордЭ рдЧрдпрд╛ рд╣реВрдБред рдЖрдкрдХреА рд╡рд┐рддреНрддреАрдп рд╕реНрдерд┐рддрд┐ рдХреЗ рдЖрдзрд╛рд░ рдкрд░, рдореИрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕реБрдЭрд╛рд╡ рджреЗрддрд╛ рд╣реВрдБ:\n\nтАв рдЕрдкрдиреЗ рдирд┐рд╡реЗрд╢ рдХреЛ diversify рдХрд░реЗрдВ\nтАв Emergency fund рдмрдирд╛рдП рд░рдЦреЗрдВ\nтАв Regular SIP рдЬрд╛рд░реА рд░рдЦреЗрдВ\n\nрдХреНрдпрд╛ рдЖрдк рдХрд┐рд╕реА рд╡рд┐рд╢рд┐рд╖реНрдЯ рд╡рд┐рд╖рдп рдкрд░ рдФрд░ рдЬрд╛рдирдХрд╛рд░реА рдЪрд╛рд╣рддреЗ рд╣реИрдВ?`
        : `I understand your question. Based on your financial profile, here are my recommendations:\n\nтАв Diversify your investments\nтАв Maintain an emergency fund\nтАв Continue regular SIPs\n\nWould you like more information on any specific topic?`;
    }

    return {
      id: Date.now() + 1,
      sender: 'ai',
      content: responseContent,
      timestamp: new Date(),
      quickActions: [
        { id: 'details', label: lang === 'hi' ? 'рдФрд░ рдЬрд╛рдирдХрд╛рд░реА' : 'More Details' },
        { id: 'implement', label: lang === 'hi' ? 'рд▓рд╛рдЧреВ рдХрд░реЗрдВ' : 'Implement' }
      ]
    };
  };

  const handleQuickAction = (action) => {
    if (typeof action === 'string') {
      // Handle string actions from quick action buttons
      const actionMessages = {
        portfolio: currentLanguage === 'hi' ? 'рдореЗрд░рд╛ рдкреЛрд░реНрдЯрдлреЛрд▓рд┐рдпреЛ рджрд┐рдЦрд╛рдПрдВ' : 'Show my portfolio',
        tax: currentLanguage === 'hi' ? 'рдЯреИрдХреНрд╕ рдмрдЪрдд рдХреЗ рддрд░реАрдХреЗ рдмрддрд╛рдПрдВ' : 'Tell me about tax saving options',
        goals: currentLanguage === 'hi' ? 'рд╡рд┐рддреНрддреАрдп рд▓рдХреНрд╖реНрдп рд╕реЗрдЯ рдХрд░рдирд╛ рдЪрд╛рд╣рддрд╛ рд╣реВрдБ' : 'I want to set financial goals',
        market: currentLanguage === 'hi' ? 'рдЖрдЬ рдХреЗ рдорд╛рд░реНрдХреЗрдЯ рдЕрдкрдбреЗрдЯ рджреЗрдВ' : 'Give me today\'s market updates'
      };
      
      if (actionMessages?.[action]) {
        handleSendMessage(actionMessages?.[action]);
      }
    } else if (action?.id) {
      // Handle action objects from chat messages
      const actionMessages = {
        portfolio: currentLanguage === 'hi' ? 'рдкреЛрд░реНрдЯрдлреЛрд▓рд┐рдпреЛ рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рджрд┐рдЦрд╛рдПрдВ' : 'Show detailed portfolio',
        goals: currentLanguage === 'hi' ? 'рд▓рдХреНрд╖реНрдп рдирд┐рд░реНрдзрд╛рд░рдг рд╢реБрд░реВ рдХрд░реЗрдВ' : 'Start goal setting',
        sip_calculator: currentLanguage === 'hi' ? 'SIP рдХреИрд▓рдХреБрд▓реЗрдЯрд░ рдЦреЛрд▓реЗрдВ' : 'Open SIP calculator',
        goal_tracker: currentLanguage === 'hi' ? 'рд▓рдХреНрд╖реНрдп рдЯреНрд░реИрдХрд░ рджрд┐рдЦрд╛рдПрдВ' : 'Show goal tracker',
        details: currentLanguage === 'hi' ? 'рдЗрд╕рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдФрд░ рдмрддрд╛рдПрдВ' : 'Tell me more about this',
        implement: currentLanguage === 'hi' ? 'рдЗрд╕реЗ рдХреИрд╕реЗ рд▓рд╛рдЧреВ рдХрд░реВрдВ?' : 'How do I implement this?'
      };

      if (actionMessages?.[action?.id]) {
        handleSendMessage(actionMessages?.[action?.id]);
      }
    }
  };

  const handleVoiceInput = (isRecording) => {
    setIsListening(isRecording);
    if (isRecording) {
      // Simulate voice recognition
      setTimeout(() => {
        const voiceMessages = currentLanguage === 'hi' 
          ? ['рдореЗрд░рд╛ рдкреЛрд░реНрдЯрдлреЛрд▓рд┐рдпреЛ рдХреИрд╕рд╛ рдЪрд▓ рд░рд╣рд╛ рд╣реИ?', 'рдЯреИрдХреНрд╕ рдмрдЪрд╛рдиреЗ рдХреЗ рддрд░реАрдХреЗ рдмрддрд╛рдПрдВ', 'SIP рдХрд┐рддрдирд╛ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП?']
          : ['How is my portfolio performing?', 'Tell me about tax saving options', 'What should be my SIP amount?'];
        
        const randomMessage = voiceMessages?.[Math.floor(Math.random() * voiceMessages?.length)];
        handleSendMessage(randomMessage);
        setIsListening(false);
      }, 3000);
    }
  };

  const handleSettingsClick = () => {
    console.log('Settings clicked');
  };

  const handleViewDetails = (insightId) => {
    const detailMessages = {
      portfolio_health: currentLanguage === 'hi' ? 'рдкреЛрд░реНрдЯрдлреЛрд▓рд┐рдпреЛ рд╕реНрд╡рд╛рд╕реНрдереНрдп рдХреА рд╡рд┐рд╕реНрддреГрдд рд░рд┐рдкреЛрд░реНрдЯ рджреЗрдВ' : 'Give detailed portfolio health report',
      tax_optimization: currentLanguage === 'hi' ? 'рдЯреИрдХреНрд╕ рдЕрдиреБрдХреВрд▓рди рдХреА рд░рдгрдиреАрддрд┐ рдмрддрд╛рдПрдВ' : 'Explain tax optimization strategy',
      goal_progress: currentLanguage === 'hi' ? 'рд▓рдХреНрд╖реНрдп рдкреНрд░рдЧрддрд┐ рдХрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░реЗрдВ' : 'Analyze goal progress'
    };

    if (detailMessages?.[insightId]) {
      handleSendMessage(detailMessages?.[insightId]);
    }
  };

  return (
    <div className="min-h-screen bg-background">
      <Header />
      
      <div className="pt-16 h-screen flex">
        {/* Main Chat Area */}
        <div className="flex-1 flex flex-col">
          <ChatHeader
            currentLanguage={currentLanguage}
            onLanguageToggle={handleLanguageToggle}
            isOnline={isOnline}
            onSettingsClick={handleSettingsClick}
            aiPersonality={{
              name: currentLanguage === 'hi' ? 'рд╡рд┐рддреНрддреАрдп рд╕рд▓рд╛рд╣рдХрд╛рд░' : 'Financial Advisor',
              type: 'expert',
              expertise: ['investment', 'tax-planning', 'retirement']
            }}
          />
          
          <ConversationHistory
            messages={messages}
            currentLanguage={currentLanguage}
            onQuickAction={handleQuickAction}
            isTyping={isTyping}
          />
          
          <QuickActionButtons
            currentLanguage={currentLanguage}
            onQuickAction={handleQuickAction}
          />
          
          <ChatInput
            currentLanguage={currentLanguage}
            onSendMessage={handleSendMessage}
            isTyping={isTyping}
            onVoiceInput={handleVoiceInput}
            isListening={isListening}
          />
        </div>

        {/* AI Insight Panel */}
        {showInsightPanel && (
          <AIInsightPanel
            currentLanguage={currentLanguage}
            onViewDetails={handleViewDetails}
            userProfile={{
              age: 32,
              income: 850000,
              riskTolerance: 'moderate',
              investmentGoals: ['retirement', 'home-purchase', 'education']
            }}
          />
        )}

        {/* Toggle Insight Panel Button */}
        <button
          onClick={() => setShowInsightPanel(!showInsightPanel)}
          className="fixed right-4 top-1/2 -translate-y-1/2 w-10 h-10 bg-primary text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-200 flex items-center justify-center z-50"
        >
          <Icon 
            name={showInsightPanel ? "ChevronRight" : "ChevronLeft"} 
            size={20} 
          />
        </button>
      </div>
    </div>
  );
};

export default AIAdvisorChatInterface;